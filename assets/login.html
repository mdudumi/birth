<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BIRTH ‚Äî Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    body{font-family:'Inter',sans-serif;background:linear-gradient(160deg,#081b2c,#0d2237);
    color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .login-card{background:#0b2136;padding:40px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.3);
    width:100%;max-width:420px}
    .login-card h1{margin-bottom:10px;font-size:26px;text-align:center}
    .login-card p{color:#bcd0df;text-align:center;margin-bottom:30px}
    input{width:100%;padding:12px;border-radius:8px;border:1px solid #2b3e56;
    background:#081b2c;color:#fff;margin-bottom:16px}
    button{width:100%;padding:12px;border:none;border-radius:8px;background:#6ed3ff;
    color:#0b2136;font-weight:700;cursor:pointer;transition:background 0.2s}
    button:hover{background:#8fe2ff}
    .msg{text-align:center;margin-top:12px;color:#ff6b6b}
    .langbtn{background:none;border:none;font-size:20px;cursor:pointer}
  </style>
</head>
<body>
  <div class="login-card" id="loginCard">
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
      <button id="langBtn" class="langbtn"
        onclick="setLang((window.currentLang||defaultLang)==='en'?'sq':'en')">üá¨üáß</button>
    </div>
    <div class="logo" style="display:flex;align-items:center;justify-content:center;margin-bottom:10px;">
      <img src="assets/logo.png" alt="BIRTH" style="height:40px;margin-right:8px;">
      <strong>BIRTH</strong>
    </div>
    <h1 data-i18n="login.title">Log in to your account</h1>
    <p data-i18n="login.hint">Access your workspace securely.</p>

    <input id="email" type="email" data-i18n="login.user" placeholder="Email" autocomplete="username" required>
    <input id="password" type="password" data-i18n="login.pass" placeholder="Password" autocomplete="current-password" required>
    <button id="loginBtn" data-i18n="login.btn">Log in</button>
    <div id="msg" class="msg"></div>
    <p style="text-align:center;margin-top:10px;">
      <a href="index.html" data-i18n="login.back">‚Üê Back to homepage</a>
    </p>
  </div>

  <!-- Password Change Card -->
  <div class="login-card" id="changeCard" style="display:none;">
    <h1 data-i18n="changepass.title">Change Your Password</h1>
    <p data-i18n="changepass.hint">Please set a new password before continuing.</p>
    <input id="newPass" type="password" data-i18n="changepass.new" placeholder="New password" required>
    <input id="confirmPass" type="password" data-i18n="changepass.confirm" placeholder="Confirm password" required>
    <button id="changeBtn" data-i18n="changepass.btn">Update Password</button>
    <div id="changeMsg" class="msg"></div>
  </div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lorhzjmcismjqpmbulkl.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxvcmh6am1jaXNtanFwbWJ1bGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MjEyNzksImV4cCI6MjA3NjQ5NzI3OX0.rGP_xMsAbzIfO7cXdRLHeKEU_ioSE7VpmhQTWVwKilY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: { persistSession: true, autoRefreshToken: true }
});


// üåê i18n setup
const I18N = {
  en: {
    login: {
      title: 'Log in to your account',
      hint: 'Access your workspace securely.',
      user: 'Email',
      pass: 'Password',
      btn: 'Log in',
      back: '‚Üê Back to homepage',
      error: 'Invalid credentials.',
      success: 'Login successful! Redirecting...',
      creating: 'Creating profile...'
    },
    changepass: {
      title: 'Change Your Password',
      hint: 'Please set a new password before continuing.',
      new: 'New password',
      confirm: 'Confirm password',
      btn: 'Update Password',
      mismatch: 'Passwords do not match.',
      success: 'Password updated successfully! Redirecting...'
    }
  },
  sq: {
    login: {
      title: 'Hyr n√´ llogarin√´ t√´nde',
      hint: 'Hyni n√´ hap√´sir√´n tuaj t√´ pun√´s me siguri.',
      user: 'Email',
      pass: 'Fjal√´kalimi',
      btn: 'Hyr',
      back: '‚Üê Kthehu n√´ faqen kryesore',
      error: 'Kredenciale t√´ pasakta.',
      success: 'Hyrje e suksesshme! Duke ju ridrejtuar...',
      creating: 'Duke krijuar profilin...'
    },
    changepass: {
      title: 'Ndrysho Fjal√´kalimin',
      hint: 'Ju lutem vendosni nj√´ fjal√´kalim t√´ ri p√´rpara se t√´ vazhdoni.',
      new: 'Fjal√´kalim i ri',
      confirm: 'P√´rs√´rit fjal√´kalimin',
      btn: 'P√´rdit√´so',
      mismatch: 'Fjal√´kalimet nuk p√´rputhen.',
      success: 'Fjal√´kalimi u p√´rdit√´sua me sukses! Duke ju ridrejtuar...'
    }
  }
};

const I18N_KEY = 'birth_lang';
const defaultLang = localStorage.getItem(I18N_KEY) || 'en';
function t(path) {
  const parts = path.split('.');
  let cur = I18N[window.currentLang || defaultLang];
  for (const p of parts) { if (cur && p in cur) cur = cur[p]; else return path; }
  return cur;
}
function applyLang(lang) {
  window.currentLang = lang;
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const val = t(key);
    if (el.tagName === 'INPUT') el.setAttribute('placeholder', val);
    else el.innerHTML = val;
  });
  document.getElementById('langBtn').textContent = (lang === 'en' ? 'üá¨üáß' : 'üá¶üá±');
}
function setLang(l) { localStorage.setItem(I18N_KEY, l); applyLang(l); }
document.addEventListener('DOMContentLoaded', () => applyLang(defaultLang));


// üîê LOGIN LOGIC
document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const msg = document.getElementById('msg');

  msg.textContent = (window.currentLang === 'sq' ? 'Duke hyr√´...' : 'Logging in...');

  try {
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) throw new Error('invalid');

    const user = data.user;
    if (!user) throw new Error('no_user');

    // Fetch profile
    let { data: profile, error: pErr } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    // Auto-create profile if missing
    if (pErr || !profile) {
      msg.textContent = (window.currentLang === 'sq' ? I18N.sq.login.creating : I18N.en.login.creating);
      const { error: upErr } = await supabase
        .from('profiles')
        .upsert([{ id: user.id, username: user.email, role: 'user', must_change_password: true }], { onConflict: 'id' });
      if (upErr) throw upErr;

      ({ data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single());
    }

    if (!profile) throw new Error('profile_load_failed');

    // Check if password change required
    if (profile.must_change_password) {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('changeCard').style.display = 'block';
      document.getElementById('changeMsg').textContent = '';
      return;
    }

    // ‚úÖ SUCCESS: redirect to platform
    msg.textContent = (window.currentLang === 'sq' ? I18N.sq.login.success : I18N.en.login.success);
    console.log('‚úÖ Login successful, redirecting to platform.html...');
    setTimeout(() => { window.location.href = 'platform.html'; }, 1000);

  } catch (err) {
    console.error('‚ùå Login error:', err);
    msg.textContent = (window.currentLang === 'sq' ? I18N.sq.login.error : I18N.en.login.error);
  }
});


// üîÑ CHANGE PASSWORD LOGIC
document.getElementById('changeBtn').addEventListener('click', async () => {
  const newPass = document.getElementById('newPass').value;
  const confirmPass = document.getElementById('confirmPass').value;
  const changeMsg = document.getElementById('changeMsg');

  if (newPass !== confirmPass) {
    changeMsg.textContent = (window.currentLang === 'sq'
      ? I18N.sq.changepass.mismatch
      : I18N.en.changepass.mismatch);
    return;
  }

  try {
    const { data: userData } = await supabase.auth.getUser();
    const user = userData?.user;
    if (!user) throw new Error('session_expired');

    const { error } = await supabase.auth.updateUser({ password: newPass });
    if (error) throw error;

    await supabase.from('profiles').update({ must_change_password: false }).eq('id', user.id);
    changeMsg.textContent = (window.currentLang === 'sq'
      ? I18N.sq.changepass.success
      : I18N.en.changepass.success);

    console.log('‚úÖ Password updated, redirecting...');
    setTimeout(() => { window.location.href = 'platform.html'; }, 1500);

  } catch (err) {
    console.error('‚ùå Change password error:', err);
    changeMsg.textContent = 'Error updating password.';
  }
});
</script>

</body>
</html>
